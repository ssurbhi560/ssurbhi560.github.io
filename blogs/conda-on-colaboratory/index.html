<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#8ab9f1}</style><title>Conda on Colaboratory</title><meta name=description content="This is the place where I write occasionally."><meta name=keywords content><meta property="og:url" content="https://ssurbhi560.github.io/blogs/conda-on-colaboratory/"><meta property="og:type" content="website"><meta property="og:title" content="Conda on Colaboratory"><meta property="og:description" content="This is the place where I write occasionally."><meta property="og:image" content><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Conda on Colaboratory"><meta name=twitter:description content="This is the place where I write occasionally."><meta property="twitter:domain" content="https://ssurbhi560.github.io/blogs/conda-on-colaboratory/"><meta property="twitter:url" content="https://ssurbhi560.github.io/blogs/conda-on-colaboratory/"><meta name=twitter:image content><link rel=canonical href=https://ssurbhi560.github.io/blogs/conda-on-colaboratory/><link rel=stylesheet type=text/css href=https://ssurbhi560.github.io//css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://ssurbhi560.github.io//css/main.css><link disabled id=dark-theme rel=stylesheet href=https://ssurbhi560.github.io//css/dark.css><script src=https://ssurbhi560.github.io//js/svg-injector.min.js></script>
<script src=https://ssurbhi560.github.io//js/feather-icons.min.js></script>
<script src=https://ssurbhi560.github.io//js/main.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.16/dist/katex.min.css integrity=sha384-6LkG2wmY8FK9E0vU9OOr8UvLwsaqUg9SETfpq4uTCN1agNe8HRdE9ABlk+fVx6gZ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.16/dist/katex.min.js integrity=sha384-31El76TwmbHj4rF9DyLsygbq6xoIobG0W+jqXim+a3dU9W53tdH3A/ngRPxOzzaB crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.16/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://ssurbhi560.github.io/><b>Surbhi Sharma</b></a></div><div class=nav-links><div class=nav-link><a href=https://ssurbhi560.github.io/about>About</a></div><div class=nav-link><a href=https://ssurbhi560.github.io/blogs/>Blogs</a></div><div class=nav-link><a href=https://ssurbhi560.github.io/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://ssurbhi560.github.io/about>About</a></li><li class=nav-item><a href=https://ssurbhi560.github.io/blogs/>Blogs</a></li><li class=nav-item><a href=https://ssurbhi560.github.io/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Conda on Colaboratory</h1><small role=doc-subtitle></small><p class=post-date>December 5, 2022</p><ul class=post-tags></ul></div><div class=post-content><p><p><img src=https://i.imgur.com/jkDS3Y4.png alt="Condacolab&rsquo;s logo"></p><h2 id=introduction>Introduction</h2><p>Hi, I am <a href=https://github.com/ssurbhi560>Surbhi</a>, and this blog post is about the work I did over the last three most exciting months in my internship at Quansight Labs. My mentor during the internship was the very amazing <a href=https://github.com/jaimergp>Jaime Rodr√≠guez-Guerra</a>. The project I worked on during the internship was <a href=https://github.com/conda-incubator/condacolab>condacolab</a>. We will shortly go into what <code>condacolab</code> is, but before that, let&rsquo;s understand a little about the two familiar names that we see here, which are <strong>conda</strong> and <strong>colab</strong> and also why we needed <code>condacolab</code> in the first place.</p><h2 id=why-condacolab->Why condacolab? üêç</h2><p><a href=https://colab.research.google.com/>Colab</a> is a product from Google Research and is widely used by software developers and data scientists today. Some reasons behind its success are:</p><ul><li>It provides a cloud-based platform to run your code. This means it is not limited by the user&rsquo;s computer resources (like RAM, disk space, CPU, or GPU).</li><li>It comes preinstalled with the most popular Python packages.</li><li>Its free plan is enough for a lot of use cases.</li><li>The resulting notebooks can be easily shared.</li></ul><p>However, some users might find that Colab has some limitations in some areas, like:</p><ul><li>Colab is still using and locked to Python 3.7. So, if you need to use any other Python version in Colab, you won&rsquo;t be able to do that easily.</li><li>Colab ships many preinstalled packages, but users can only use <code>apt</code> or <code>pip</code> to update or obtain new ones.</li></ul><p>This means you won&rsquo;t be able to use any other package manager like <a href=https://docs.conda.io/projects/conda/en/latest/>conda</a>, which can be a better option for certain projects and data-science fields. You might be able to do get <code>conda</code> on colab after some hacking, but this kind of workarounds tend to be break often and lack reusability.</p><p>To help folks with these limitations and make Colab more user-friendly for <code>conda</code> users, we have condacolab.</p><h2 id=what-is-condacolab-and-how-does-it-work>What is condacolab, and how does it work?</h2><p><a href=https://github.com/conda-incubator/condacolab>Condacolab</a> is a tool that lets you deploy a Miniconda installation easily on Google Colab notebooks and use conda or mamba in colab.</p><hr><p><img src=https://i.imgur.com/u3H8rUs.png alt="Screenshot that shows the Google Colab interface on the browser with three cells of code. The first cell installs condacolab with pip. A second cell runs condacolab.install() to download and install conda to /usr/local. A third cell installs OpenMM with conda."></p><hr><p>The way condacolab worked before was by installing the Miniconda distribution on top of the system&rsquo;s Python at <code>/usr/local</code>, and then adding a few configuration files to ensure we stay with Python 3.7. Finally, it wrapped the Python executable to redirect and inject some environment variables needed to load the new libraries installed by <code>conda</code>. Since we need to re-read <code>LD_LIBRARY_PATH</code>, it triggered a Jupyter kernel restart.</p><p>The problem with this approach is that we are still stuck with Python 3.7 and overwriting the system&rsquo;s Python executable. This is not the best way because we are leaving some original Colab libraries that depend on other packages, resulting in a chaotic mixture of conda-provided files with colab-preinstalled files. In most simple cases, this doesn&rsquo;t present much of a problem. However, if users rely on more complex packages with compiled dependencies, chances are you would often run into difficult to debug errors due to ABI incompatibilities.</p><h2 id=adopting-a-better-solution->Adopting a better solution ü•≥</h2><p>The first goal we worked on during the internship was to design and implement a more robust solution to use conda and/or mamba on colab.</p><p>After some iterations, we settled for the following approach:</p><ol><li>We install the Miniconda distribution (or any other distribution) at <code>/opt/conda</code> instead of <code>/usr/local</code>.</li><li>We supplement the <code>base</code> environment with colab-required packages, like <code>google-colab</code>, <code>condatools</code>, <code>psutil</code>, and <code>matplotlib</code>.</li><li>We overwrite <code>/usr/local/python</code> (the executable run by the default ipykernel) with a shell script that activates conda and starts our custom ipykernel, forwarding the calls there. Thanks to this step, the Jupyter server will not even notice, but we are now running conda&rsquo;s Python without touching the system one at all!</li></ol><pre tabindex=0><code>#!/bin/bash
source {prefix}/etc/profile.d/conda.sh
conda activate
unset PYTHONPATH
mv /usr/bin/lsb_release /usr/bin/lsb_release.renamed_by_condacolab.bak
exec {bin_path}/python $@
</code></pre><p>Bash script which activates the conda base environment and then runs the ipykernel process.</p><hr><h2 id=some-other-work-we-did-for-condacolab>Some other work we did for condacolab</h2><h3 id=1-adding-a-restart-kernel-button>1. Adding a <code>Restart kernel</code> button.</h3><p>During the installation of condacolab the kernel is restarted automatically. This could make users feel like something is wrong with the installation or Colab. We now added a button to restart the kernel to resolve this issue. If you set <code>restart_kernel</code> to <code>False</code> during the installation, then the kernel will not restart automatically, and a button will appear, which you can click to restart the kernel.</p><hr><p><img src=https://i.imgur.com/fxsE4jj.png alt="using restart_kernel argument to get a button for kernel restart."></p><hr><h3 id=2-api-for-customizing-the-conda-base-environment>2. API for customizing the conda base environment.</h3><p>We also worked on building an API that would give users the option to customize the newly activated conda base environment during the condacolab installation. The API provides the following options that users can specify:</p><ol><li><code>environment_file</code>: This can be a URL or path to an environment.yaml file.</li><li><code>specs</code>: This is a list of additional specifications (packages) to install.</li><li><code>python_version</code>: Python version to use in the conda base environment</li><li><code>channels</code>: Comma-separated list of channels to use in the conda base environment.</li><li><code>pip_args</code>: List of additional packages to be installed using pip</li><li><code>extra_conda_args</code>: This is a list of any extra conda arguments used during the installation.</li></ol><p>The PR with the ongoing work for this has been opened here: <a href=https://github.com/conda-incubator/condacolab/pull/38>API for customizing the conda base environment. #38</a></p><pre tabindex=0><code>condacolab.install(
    environment_file=&#34;https://raw.githubusercontent.com/ssurbhi560/condacolab/07b92d827f56a4628a52f4f138ae92be3de5073d/environment.yaml&#34;,
    python_version=&#34;3.10&#34;,
    specs=[&#34;matplotlib&#34;, &#34;numpy&#34;],
    channels=[&#34;conda-forge&#34;, &#34;bioconda&#34;],
    pip_args=[&#34;blue&#34;]
    extra_conda_args=[&#34;-yq&#34;]
    )
</code></pre><p>This is how users will be able to use the API while installing condacolab.</p><h3 id=3-custom-installers-built-with-the-constructor>3. Custom installers built with the constructor.</h3><p>As mentioned above, in the new solution we are using for condacolab, some extra packages are also installed (not just Miniconda), which has increased the time for the installation of condacolab. So, to save some time during the installation and make condacolab faster, we are planning on pre-bundling these extra dependencies in custom installers built with the <a href=https://github.com/conda/constructor>constructor</a>.</p><h2 id=my-learnings-and-acknowledgements->My Learnings and Acknowledgements ‚ú®</h2><p>During my internship, I met many intelligent and cool folks at Quansight, and interacting with them helped me develop a new perspective. I am so grateful for the wonderful and invaluable experience I had during the internship. The various things I learned and discovered don&rsquo;t include just technical skills but also skills like better communication, collaborating, overcoming the imposter syndrome, debugging when you are stuck, and so many more. Thanks a ton to all the people who made this internship program possible. And a special thanks to Jaime for being the coolest mentor I have ever had, always helping and giving advice when I was stuck, cracking the wittiest jokes, and making our calls and work fun.</p><p>This blog is also published <a href=https://t.co/suJOPityCG>here</a>!</p></p></div></div></main><footer class=footer><span>&copy; 2023 <a target=_blank href=https://ssurbhi560.github.io>Surbhi Sharma</a></span>
<span>Made using <a target=_blank href=https://gohugo.io/>Hugo</a> and <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a> with some modifications.</span></footer></body></html>